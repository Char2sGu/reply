import{a as k,b as B}from"./chunk-NOLSZMK5.js";import{F as L,I as v,K as x,L as p,M as S,O as l,S as n,V as s,e as b,ea as w,fb as G,gd as u,ha as U,j as a,k as z,m as c,n as T,rd as J,s as O,sd as N,v as g,x as E}from"./chunk-GLFUZ6DN.js";import{a as j,b as R}from"./chunk-OPXGAHDX.js";var W=(()=>{let t=class extends N{identify(e){return e.id}},o=t;return(()=>{t.\u0275fac=function(){let e;return function(i){return(e||(e=w(t)))(i||t)}}()})(),(()=>{t.\u0275prov=n({token:t,factory:t.\u0275fac,providedIn:"root"})})(),o})();var q=new U("LOCAL_STORAGE");var y=o=>t=>t.pipe(p(f=>o.record(f))),I=o=>t=>t.pipe(c(f=>f.map(e=>o.record(e))),p(f=>f.length?T(f):a([]))),pt=o=>t=>t.pipe(E(f=>{throw o.undo(),f}));var H=(()=>{let t=class{},o=t;return(()=>{t.\u0275fac=function(r){return new(r||t)}})(),(()=>{t.\u0275prov=n({token:t,factory:function(e){return ot.\u0275fac(e)},providedIn:"root"})})(),o})(),ot=(()=>{let t=class{identify(e){return e.email}},o=t;return(()=>{t.\u0275fac=function(r){return new(r||t)}})(),(()=>{t.\u0275prov=n({token:t,factory:t.\u0275fac})})(),o})();var K,P=(()=>{let t=class{constructor(){this.storage=s(q),this.value$=new b(void 0),this[K]=()=>this.value$.pipe(g(e=>e!==void 0),x(this.get()))}set(e){this.storage.setItem(this.key,this.stringify(e)),this.value$.next(e)}get(){if(this.value$.value!==void 0)return this.value$.value;let e=this.storage.getItem(this.key),r=e?this.parse(e):null;return this.value$.next(r),r}clear(){this.storage.removeItem(this.key),this.value$.next(null)}parse(e){return JSON.parse(e)}stringify(e){return JSON.stringify(e)}},o=t;return(()=>{K=Symbol.observable})(),(()=>{t.\u0275fac=function(r){return new(r||t)}})(),(()=>{t.\u0275prov=n({token:t,factory:t.\u0275fac})})(),o})();var Q=(()=>{let t=class{constructor(){this.accounts=s(rt)}list(){let e=this.accounts.get();return e||(e=[],this.accounts.set(e)),e}create(e){let r=this.list();r.push(e),this.accounts.set(r)}patch(e,r){let i=this.list();if(i.findIndex(m=>m.id===e)<0)throw new M;let et=i.map(m=>m.id===e?R(j(j({},m),r),{id:m.id}):m);this.accounts.set(et)}put(e){let i=this.list().find(h=>h.id===e.id);return i?this.patch(i.id,e):this.create(e)}delete(e){let r=this.list(),i=r.findIndex(h=>h.id===e);if(i<0)throw new M;r.splice(i,1),this.accounts.set(r)}},o=t;return(()=>{t.\u0275fac=function(r){return new(r||t)}})(),(()=>{t.\u0275prov=n({token:t,factory:t.\u0275fac,providedIn:"root"})})(),o})(),D=class extends u{},M=class extends D{},rt=(()=>{let t=class extends P{constructor(){super(...arguments),this.key="accounts"}parse(e){return JSON.parse(e).map(i=>({id:i.id,profile:i.profile,authorizedAt:new Date(i.authorizedAt)}))}},o=t;return(()=>{t.\u0275fac=function(){let e;return function(i){return(e||(e=w(t)))(i||t)}}()})(),(()=>{t.\u0275prov=n({token:t,factory:t.\u0275fac,providedIn:"root"})})(),o})();var V=(()=>{let t=class{constructor(){this.identifier=s(H),this.repo=s(W),this.resource=s(Q)}loadAccounts(){return a(null).pipe(c(()=>this.resource.list()),I(this.repo))}saveAccount(e){return a(null).pipe(c(()=>({id:this.identifier.identify(e),profile:e.id,authorizedAt:new Date})),l(r=>this.resource.put(r)),y(this.repo))}deleteAccount(e){return a(null).pipe(l(()=>{this.resource.delete(e.id),this.repo.delete(e.id)}),c(()=>{}))}},o=t;return(()=>{t.\u0275fac=function(r){return new(r||t)}})(),(()=>{t.\u0275prov=n({token:t,factory:t.\u0275fac,providedIn:"root"})})(),o})();var X=(()=>{let t=class{applyChange(e,r){try{switch(r.type){case"deletion":{e.delete(r.id);break}case"creation":{e.insert(r.payload);break}case"update":{e.patch(r.id,r.payload);break}case"creation-or-update":e.record(r.payload);break;default:throw new $(r)}}catch(i){if(i instanceof J)return;throw i}}applyChanges(e,r){r.forEach(i=>{this.applyChange(e,i)})}},o=t;return(()=>{t.\u0275fac=function(r){return new(r||t)}})(),(()=>{t.\u0275prov=n({token:t,factory:t.\u0275fac,providedIn:"root"})})(),o})(),C=class extends u{},$=class extends C{constructor(t){super(`Invalid sync change type "${t.type}"`)}};var Z=(()=>{let t=class{},o=t;return(()=>{t.\u0275fac=function(r){return new(r||t)}})(),(()=>{t.\u0275prov=n({token:t,factory:t.\u0275fac})})(),o})(),Y=class extends u{};var _=(()=>{let t=class{constructor(){this.backend=s(Z),this.repo=s(B),this.syncApplier=s(X),this.syncToken$=new b(null)}loadContacts(){let e=this.backend.loadContacts().pipe(I(this.repo));return this.backend.obtainSyncToken().pipe(l(r=>this.syncToken$.next(r)),p(()=>e))}loadContact(e){return this.backend.loadContact(e).pipe(y(this.repo))}loadUser(){return this.backend.loadUser().pipe(y(this.repo))}syncContacts(){return this.syncToken$.pipe(L(),p(e=>e?this.backend.syncContacts(e):z(()=>new F)),l(e=>this.syncToken$.next(e.syncToken)),l(e=>this.syncApplier.applyChanges(this.repo,e.changes)),c(()=>{}))}},o=t;return(()=>{t.\u0275fac=function(r){return new(r||t)}})(),(()=>{t.\u0275prov=n({token:t,factory:t.\u0275fac,providedIn:"root"})})(),o})(),A=class extends u{},F=class extends A{};var tt=(()=>{let t=class{constructor(){this.authorizationChange=new G,this.authorization$=this.authorizationChange.pipe(x(null),v(1))}setAuthorization(e){if(!e)return this.authorizationChange.emit(null),!0;let i=k(e.issuedAt).add(e.lifespan,"seconds"),h=()=>k().add(1,"minute").isAfter(i);return h()?!1:(this.authorizationChange.emit(e),O(0,30*1e3).pipe(S(this.authorizationChange),g(()=>h())).subscribe(()=>{this.authorizationChange.emit(null)}),!0)}},o=t;return(()=>{t.\u0275fac=function(r){return new(r||t)}})(),(()=>{t.\u0275prov=n({token:t,factory:t.\u0275fac,providedIn:"root"})})(),o})();var oe=(()=>{let t=class{constructor(){this.authService=s(tt),this.contactConductor=s(_),this.accountConductor=s(V),this.authorized$=this.authService.authorization$.pipe(c(Boolean)),this.user$=this.authorized$.pipe(p(e=>e?this.contactConductor.loadUser():a(null)),v(1)),this.account$=this.user$.pipe(p(e=>e?this.accountConductor.saveAccount(e):a(null)),v(1))}},o=t;return(()=>{t.\u0275fac=function(r){return new(r||t)}})(),(()=>{t.\u0275prov=n({token:t,factory:t.\u0275fac,providedIn:"root"})})(),o})();export{Z as a,Y as b,y as c,I as d,pt as e,W as f,q as g,V as h,X as i,_ as j,tt as k,oe as l};
