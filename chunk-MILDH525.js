import{I as m,K as d,O as x,R as y,d as f,e as v,fa as w,m as u,v as l}from"./chunk-HFIM43UT.js";import{a as o,b as p}from"./chunk-OPXGAHDX.js";var a=class extends Error{},n=class extends a{},c=class extends a{};var h=class{constructor(){this.updatesSubject=new f,this.updates$=this.updatesSubject.asObservable(),this.entities=new Map}query(t=()=>!0){let r=new Set;for(let[e,s]of this.entities)t(s.value)&&r.add(e);return this.updates$.pipe(u(e=>e.curr&&t(e.curr)?(r.add(e.id),!0):r.delete(e.id)),d(!0),l(Boolean),u(()=>[...r].map(e=>{let s=this.entities.get(e);if(!s)throw new Error("Entity in results but missing");return s.value})),m(1))}retrieve(t){let r=this.entities.get(t);if(!r)throw new n;return r}insert(t){let r=this.identify(t);if(this.entities.has(r))throw new c;let e=new v(t);return this.entities.set(r,e),this.createUpdate({id:r,prev:null,curr:t,entity$:e,undo:()=>this.delete(r)})}patch(t,r){let e=this.entities.get(t);if(!e)throw new n;let s=e.value;return e.next(o(o({},s),r)),this.createUpdate({id:t,prev:s,curr:e.value,entity$:e,undo:()=>this.patch(t,s)})}insertOrPatch(t){let r=this.identify(t);return this.entities.get(r)?this.patch(r,t):this.insert(t)}delete(t){let r=this.entities.get(t);if(!r)throw new n;let e=r.value;return r.complete(),this.entities.delete(t),this.createUpdate({id:t,prev:e,curr:null,entity$:r,undo:()=>this.insert(e)})}exists(t){let r=this.entities.has(t);return this.updates$.pipe(l(e=>e.id===t),x(e=>{e.curr===null?r=!1:r=!0}),d(null),u(()=>r))}createUpdate(t){let r=p(o({},t),{[Symbol.observable]:()=>t.entity$});return this.updatesSubject.next(r),r}};var M=(()=>{let t=class extends h{identify(e){return e.id}},i=t;return(()=>{t.\u0275fac=function(){let e;return function(b){return(e||(e=w(t)))(b||t)}}()})(),(()=>{t.\u0275prov=y({token:t,factory:t.\u0275fac,providedIn:"root"})})(),i})();export{h as a,M as b};
