import{K as m,M as d,Q as x,T as y,d as f,e as v,ha as w,m as a,v as l}from"./chunk-LCFD4RLU.js";import{a as u,b as p}from"./chunk-OPXGAHDX.js";var n=class extends Error{},o=class extends n{},c=class extends n{},b=class extends n{},g=class extends n{};var h=class{constructor(){this.updatesSubject=new f,this.updates$=this.updatesSubject.asObservable(),this.entities=new Map}query(t=()=>!0){let r=new Set;for(let[e,i]of this.entities)t(i.value)&&r.add(e);return this.updates$.pipe(a(e=>e.curr&&t(e.curr)?(r.add(e.id),!0):r.delete(e.id)),d(!0),l(Boolean),a(()=>[...r].map(e=>{let i=this.entities.get(e);if(!i)throw new Error("Entity in results but missing");return i.value})),m(1))}retrieve(t){let r=this.entities.get(t);if(!r)throw new o;return r}insert(t){let r=this.identify(t);if(this.entities.has(r))throw new c;let e=new v(t);return this.entities.set(r,e),this.createUpdate({id:r,prev:null,curr:t,entity$:e,undo:()=>this.delete(r)})}patch(t,r){let e=this.entities.get(t);if(!e)throw new o;let i=e.value;return e.next(u(u({},i),r)),this.createUpdate({id:t,prev:i,curr:e.value,entity$:e,undo:()=>this.patch(t,i)})}insertOrPatch(t){let r=this.identify(t);return this.entities.get(r)?this.patch(r,t):this.insert(t)}delete(t){let r=this.entities.get(t);if(!r)throw new o;let e=r.value;return r.complete(),this.entities.delete(t),this.createUpdate({id:t,prev:e,curr:null,entity$:r,undo:()=>this.insert(e)})}exists(t){let r=this.entities.has(t);return this.updates$.pipe(l(e=>e.id===t),x(e=>{e.curr===null?r=!1:r=!0}),d(null),a(()=>r))}createUpdate(t){let r=p(u({},t),{[Symbol.observable]:()=>t.entity$});return this.updatesSubject.next(r),r}};var D=(()=>{let t=class extends h{identify(e){return e.id}},s=t;return(()=>{t.\u0275fac=function(){let e;return function(j){return(e||(e=w(t)))(j||t)}}()})(),(()=>{t.\u0275prov=y({token:t,factory:t.\u0275fac,providedIn:"root"})})(),s})();export{b as a,g as b,h as c,D as d};
